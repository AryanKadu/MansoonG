<%- include('_layouts/header') %>

<link rel="stylesheet" href="/css/all_products.css">


<div class="text-center mt-4 mb-4">
    <h1><i style="color: rgb(28, 120, 186);">All Products</i></h1>
</div>


<div class="row products">
  <% products.forEach(function(p) { %>
    <div class="col-12 col-md-4 mb-4">
      <div class="card h-100 shadow-sm">
        <a class="pa" href="/products/<%= p.category %>/<%= p.slug %>">
          <% if (p.image) { %>
            <img class="card-img-top pimage" src="<%= p.image %>" alt="<%= p.title %> image">
          <% } else { %>
            <img class="card-img-top pimage" src="/images/default.jpg" alt="Default image">
          <% } %>
        </a>
        <div class="card-body text-center">
          <h5 class="card-title mb-2"><%= p.title %></h5>
          <h4 class="text-success fw-bold mb-2">‚Çπ <%= parseFloat(p.price).toFixed(2) %></h4>
          <p><strong>Size:</strong> <%= p.size %> ml</p>


          <% if (p.tt > 0 && p.inStock) { %>
            <a class="btn mb-2" style="background-color: #FFD700; color: #1C1C1C;" href="/products/<%= p.category %>/<%= p.slug %>">Buy Now</a>

            <% if (loggedIn) { %>
              <!-- <a class="btn btn-outline-secondary" href="/cart/add/<%= p.slug %>">Add to Cart</a> -->
              <a class="btn" style="background-color:#1C1C1C; color: #e8fff5;" href="/cart/add/<%= p.slug %>" aria-label="Add <%= p.title %> to cart">Add to Cart</a>

            <% } %>

          <% } else { %>
            <span class="badge bg-danger">Out of Stock</span>
          <% } %>
        </div>
      </div>
    </div>
  <% }) %>
</div>

<%- include('_layouts/footer') %>

<script>
  // Add to Cart Alert Functionality
document.addEventListener('DOMContentLoaded', function() {
    
    // Show Add to Cart Alert
    function showAddToCartAlert(productName = 'Item') {
        // Remove any existing alerts
        const existingAlert = document.querySelector('.custom-alert');
        if (existingAlert) {
            existingAlert.remove();
        }

        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = 'custom-alert';
        alertDiv.innerHTML = `
            <span class="alert-icon">üõí</span>
            <span>${productName} added to cart successfully!</span>
            <button class="close-btn" onclick="this.parentElement.remove()">√ó</button>
        `;

        // Add to page
        document.body.appendChild(alertDiv);

        // Show alert with animation
        setTimeout(() => {
            alertDiv.classList.add('show');
        }, 100);

        // Auto remove after 4 seconds
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.classList.remove('show');
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 300);
            }
        }, 4000);
    }

    // Initialize Add to Cart Alert
    function initializeAddToCartAlert() {
        const addToCartLinks = document.querySelectorAll('a[href*="/cart/add/"]');
        
        addToCartLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Get product name from page header
                // const productName = document.querySelector('.page-header')?.textContent || 'Product';
                const productName = link.closest('.card').querySelector('.card-title')?.textContent || 'Product';

                
                // Show alert
                showAddToCartAlert(productName);

                link.textContent = "‚úî Added";
                link.classList.remove("btn-outline-secondary");
                link.classList.add("btn-success", "disabled");

                
                // Add to cart via AJAX
                addToCartAjax(this.href, productName);
            });
        });
    }

    // AJAX Add to Cart
    function addToCartAjax(url, productName) {
        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.ok) {
                console.log('Product added to cart successfully');
            } else {
                showErrorAlert('Failed to add product to cart. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorAlert('Network error. Please check your connection.');
        });
    }

    // Show Error Alert
    function showErrorAlert(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'custom-alert error-alert';
        alertDiv.innerHTML = `
            <span class="alert-icon">‚ö†Ô∏è</span>
            <span>${message}</span>
            <button class="close-btn" onclick="this.parentElement.remove()">√ó</button>
        `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.classList.add('show');
        }, 100);

        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.classList.remove('show');
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 300);
            }
        }, 5000);
    }

    // Initialize the alert functionality
    initializeAddToCartAlert();
});
</script>
